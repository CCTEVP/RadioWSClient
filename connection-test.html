<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Connection Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .connecting {
        background-color: #fff3cd;
        color: #856404;
      }
      .logs {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px 0;
      }
      .log-entry {
        margin: 2px 0;
      }
      .info {
        color: #17a2b8;
      }
      .error {
        color: #dc3545;
      }
      .success {
        color: #28a745;
      }
      button {
        margin: 5px;
        padding: 8px 16px;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Connection Stability Test</h1>

    <div id="controlStatus" class="status disconnected">
      Control Client: Disconnected
    </div>
    <div id="playerStatus" class="status disconnected">
      Player Client: Disconnected
    </div>

    <button onclick="testBothConnections()">Start Both Connections</button>
    <button onclick="stopBothConnections()">Stop Both Connections</button>
    <button onclick="clearLogs()">Clear Logs</button>

    <div id="logs" class="logs"></div>

    <script>
      const WS_URL = "wss://radiowsserver-763503917257.europe-west1.run.app/";
      let wsControl = null;
      let wsPlayer = null;
      let controlHeartbeat = null;
      let playerHeartbeat = null;
      const HEARTBEAT_INTERVAL = 30000; // 30 seconds

      function log(message, type = "info") {
        const logsEl = document.getElementById("logs");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
        logsEl.appendChild(entry);
        logsEl.scrollTop = logsEl.scrollHeight;
      }

      function updateStatus(clientType, status) {
        const statusEl = document.getElementById(`${clientType}Status`);
        statusEl.className = `status ${status}`;
        statusEl.textContent = `${
          clientType.charAt(0).toUpperCase() + clientType.slice(1)
        } Client: ${status.charAt(0).toUpperCase() + status.slice(1)}`;
      }

      function startHeartbeat(ws, clientType) {
        const heartbeatTimer = setInterval(() => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            const keepAlive = JSON.stringify({
              type: "keepalive",
              timestamp: new Date().toISOString(),
              clientId: clientType,
            });
            ws.send(keepAlive);
            log(`${clientType} keepalive sent`, "info");
          }
        }, HEARTBEAT_INTERVAL);

        if (clientType === "control") {
          controlHeartbeat = heartbeatTimer;
        } else {
          playerHeartbeat = heartbeatTimer;
        }
      }

      function stopHeartbeat(clientType) {
        const timer =
          clientType === "control" ? controlHeartbeat : playerHeartbeat;
        if (timer) {
          clearInterval(timer);
          if (clientType === "control") {
            controlHeartbeat = null;
          } else {
            playerHeartbeat = null;
          }
        }
      }

      function createConnection(clientType) {
        const ws = new WebSocket(WS_URL);
        const startTime = Date.now();

        ws.onopen = () => {
          log(`${clientType} connected successfully`, "success");
          updateStatus(clientType, "connected");
          startHeartbeat(ws, clientType);
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === "welcome") {
              log(`${clientType} server welcome: ${data.message}`, "success");
            } else if (data.type === "broadcast") {
              log(
                `${clientType} broadcast from ${data.from}: ${JSON.stringify(
                  data.data
                )}`,
                "info"
              );
            } else {
              log(`${clientType} received: ${JSON.stringify(data)}`, "info");
            }
          } catch (e) {
            log(`${clientType} received: ${event.data}`, "info");
          }
        };

        ws.onclose = (event) => {
          const duration = Math.round((Date.now() - startTime) / 1000);
          log(
            `${clientType} disconnected after ${duration}s (Code: ${event.code})`,
            "error"
          );
          updateStatus(clientType, "disconnected");
          stopHeartbeat(clientType);
        };

        ws.onerror = (error) => {
          log(`${clientType} error occurred`, "error");
          updateStatus(clientType, "error");
        };

        return ws;
      }

      function testBothConnections() {
        log("Starting connection stability test...", "success");

        wsControl = createConnection("control");
        wsPlayer = createConnection("player");

        // Log connection duration every 5 minutes
        setInterval(() => {
          if (
            (wsControl && wsControl.readyState === WebSocket.OPEN) ||
            (wsPlayer && wsPlayer.readyState === WebSocket.OPEN)
          ) {
            const now = new Date();
            log(
              `Connection check at ${now.toLocaleTimeString()} - Both clients monitored`,
              "info"
            );
          }
        }, 300000); // 5 minutes
      }

      function stopBothConnections() {
        if (wsControl) {
          wsControl.close();
          wsControl = null;
        }
        if (wsPlayer) {
          wsPlayer.close();
          wsPlayer = null;
        }
        stopHeartbeat("control");
        stopHeartbeat("player");
        log("All connections stopped", "info");
      }

      function clearLogs() {
        document.getElementById("logs").innerHTML = "";
      }
    </script>
  </body>
</html>
